<template>
  <teleport to="body">
    <div v-if="visible" class="keyboard-help-overlay" @click.self="close" role="dialog" aria-modal="true" aria-label="Keyboard shortcuts help">
      <div class="keyboard-help-panel" ref="panel" tabindex="-1">
      <header class="kbd-header">
        <h3>é”®ç›˜å¿«æ·é”®</h3>
        <button class="close" @click="close" aria-label="Close keyboard help">âœ•</button>
      </header>

      <div class="kbd-body">
        <div class="kbd-content">
          <div class="shortcut-group">
            <h4 class="group-title">å¯¼èˆªå¿«æ·é”®</h4>
            <ul class="shortcuts">
              <li><span class="kbd"><kbd class="kbd-key highlight">Ctrl</kbd> + <kbd class="kbd-key highlight">1</kbd></span>ï¼šè·³è½¬åˆ°é¦–é¡µ (Home)</li>
              <li><span class="kbd"><kbd class="kbd-key highlight">Ctrl</kbd> + <kbd class="kbd-key highlight">2</kbd></span>ï¼šè·³è½¬åˆ°ç®—æ³•å­¦ä¹ é¡µ (Learn)</li>
              <li><span class="kbd"><kbd class="kbd-key highlight">Ctrl</kbd> + <kbd class="kbd-key highlight">3</kbd></span>ï¼šè·³è½¬åˆ°ç¤¾åŒºé¡µé¢ (Community)</li>
              <li><span class="kbd"><kbd class="kbd-key highlight">Ctrl</kbd> + <kbd class="kbd-key highlight">4</kbd></span>ï¼šè·³è½¬åˆ°èŠå¤©é¡µé¢ (Chat)</li>
              <li><span class="kbd"><kbd class="kbd-key highlight">Ctrl</kbd> + <kbd class="kbd-key highlight">5</kbd></span>ï¼šè·³è½¬åˆ°ä¸ªäººèµ„æ–™é¡µ (Profile)</li>
              <li><span class="kbd"><kbd class="kbd-key highlight">Ctrl</kbd> + <kbd class="kbd-key highlight">6</kbd></span>ï¼šè·³è½¬åˆ°ç®¡ç†é¡µé¢ (Admin)</li>
            </ul>
          </div>

          <div class="shortcut-group">
            <h4 class="group-title">é¡µé¢æ“ä½œ</h4>
            <ul class="shortcuts">
              <li><span class="kbd"><kbd class="kbd-key highlight">Ctrl</kbd> + <kbd class="kbd-key highlight">+</kbd></span>ï¼šåœ¨ç¤¾åŒºé¡µé¢åˆ›å»ºæ–°å¸–å­</li>
              <li><span class="kbd"><kbd class="kbd-key highlight">Ctrl</kbd> + <kbd class="kbd-key highlight">P</kbd></span>ï¼šåœ¨å¸–å­è¯¦æƒ…é¡µæ”¶è—/å–æ¶ˆæ”¶è—</li>
              <li><span class="kbd"><kbd class="kbd-key highlight">Ctrl</kbd> + <kbd class="kbd-key highlight">K</kbd></span>ï¼šèšç„¦æœç´¢æ¡†</li>
              <li><span class="kbd"><kbd class="kbd-key highlight">Ctrl</kbd> + <kbd class="kbd-key highlight">G</kbd></span>ï¼šè·³è½¬åˆ°å½“å‰é¡µé¢çš„ç¬¬Nä¸ªå¸–å­</li>
            </ul>
          </div>

          <div class="shortcut-group">
            <h4 class="group-title">è¾…åŠ©åŠŸèƒ½æ¨¡å¼</h4>
            <ul class="shortcuts">
              <li v-if="isMac">
                <span class="kbd"><kbd class="kbd-key highlight">âŒ¥ Option</kbd> / <kbd class="kbd-key highlight">âŒ˜ Cmd</kbd> + <kbd class="kbd-key highlight">A</kbd></span>ï¼šå¼€å¯/å…³é—­è¾…åŠ©åŠŸèƒ½æ¨¡å¼
              </li>
              <li v-else>
                <span class="kbd"><kbd class="kbd-key highlight">Alt</kbd> + <kbd class="kbd-key highlight">A</kbd></span>ï¼šå¼€å¯/å…³é—­è¾…åŠ©åŠŸèƒ½æ¨¡å¼
              </li>
              <li v-if="isMac">
                <span class="kbd"><kbd class="kbd-key highlight">âŒ¥ Option</kbd> / <kbd class="kbd-key highlight">âŒ˜ Cmd</kbd> + <kbd class="kbd-key highlight">1-9</kbd></span>ï¼šå¿«é€Ÿè·³è½¬åˆ°å¯¹åº”åºå·çš„å¸–å­ï¼ˆè¾…åŠ©æ¨¡å¼ä¸‹ï¼‰
              </li>
              <li v-else>
                <span class="kbd"><kbd class="kbd-key highlight">Alt</kbd> + <kbd class="kbd-key highlight">1-9</kbd></span>ï¼šå¿«é€Ÿè·³è½¬åˆ°å¯¹åº”åºå·çš„å¸–å­ï¼ˆè¾…åŠ©æ¨¡å¼ä¸‹ï¼‰
              </li>
            </ul>
            <p class="group-desc">å¯ç”¨è¾…åŠ©åŠŸèƒ½æ¨¡å¼åï¼Œæ¯ä¸ªå¸–å­å¡ç‰‡ä¼šæ˜¾ç¤ºå¿«æ·é”®æç¤ºï¼Œè®©æ‚¨å¯ä»¥é€šè¿‡é”®ç›˜å¿«é€Ÿå¯¼èˆªã€‚</p>
            <p v-if="isMac" class="group-note mac-note">
              <strong>Macç”¨æˆ·æç¤ºï¼š</strong> å¯ä»¥ä½¿ç”¨ <kbd>âŒ¥ Option</kbd> é”®æˆ– <kbd>âŒ˜ Cmd</kbd> + A æ¥åˆ‡æ¢è¾…åŠ©æ¨¡å¼ï¼Œ<kbd>âŒ¥ Option</kbd> / <kbd>âŒ˜ Cmd</kbd> + æ•°å­—é”®æ¥å¿«é€Ÿè·³è½¬ã€‚
            </p>
          </div>

          <div class="shortcut-group">
            <h4 class="group-title">é€šç”¨æ“ä½œ</h4>
          <ul class="shortcuts">
              <li><span class="kbd"><kbd class="kbd-key highlight">Ctrl</kbd> + <kbd class="kbd-key highlight">[</kbd></span>ï¼šå†å²åé€€</li>
              <li><span class="kbd"><kbd class="kbd-key highlight">Ctrl</kbd> + <kbd class="kbd-key highlight">]</kbd></span>ï¼šå†å²å‰è¿›</li>
              <li><span class="kbd"><kbd class="kbd-key">?</kbd></span>ï¼šæ˜¾ç¤º/éšè—é”®ç›˜å¸®åŠ©</li>
              <li><span class="kbd"><kbd class="kbd-key">Space</kbd></span>ï¼šæ’­æ”¾/æš‚åœï¼ˆäº¤äº’æ¼”ç¤ºï¼‰</li>
              <li><span class="kbd"><kbd class="kbd-key">C</kbd></span>ï¼šå…³é—­æ¨¡æ€æ¡†/è¿”å›ä¸Šä¸€çº§</li>
              <li><span class="kbd"><kbd class="kbd-key">Esc</kbd></span>ï¼šå…³é—­é”®ç›˜å¸®åŠ©</li>
          </ul>
          </div>
        </div>
      </div>
      <footer class="kbd-footer">
        <small>æŒ‰ <kbd>Esc</kbd> æˆ–ç‚¹å‡»ç©ºç™½å¤„å…³é—­ã€‚é¢œè‰²ä¸ç«™ç‚¹ä¸»é¢˜ä¸€è‡´ã€‚</small>
        <div v-if="isMac" class="mac-info">
          <small>ğŸ’¡ Macç”¨æˆ·ï¼šä½¿ç”¨ <kbd>âŒ¥ Option</kbd> é”®ä»£æ›¿ <kbd>Alt</kbd> é”®</small>
        </div>
      </footer>
      </div>
    </div>
  </teleport>
</template>

<script setup lang="ts">
import { ref, onMounted, onBeforeUnmount, computed } from 'vue'
import { useRouter } from 'vue-router'

// æ£€æµ‹æ“ä½œç³»ç»Ÿ
const isMac = computed(() => {
  return navigator.platform.toUpperCase().indexOf('MAC') >= 0
})

const visible = ref(false)
const panel = ref<HTMLElement | null>(null)
const router = useRouter()


const open = () => {
  visible.value = true
  // trap focus
  setTimeout(() => panel.value?.focus(), 0)
  document.body.style.overflow = 'hidden'
}
const close = () => {
  visible.value = false
  document.body.style.overflow = ''
}

const onGlobalToggle = (e: Event) => {
  const detail = (e as CustomEvent).detail
  if (detail && typeof detail.open === 'boolean') {
    if (detail.open) open(); else close()
  } else {
    // simple toggle if no detail
    if (visible.value) close(); else open()
  }
}

const onKey = (ev: KeyboardEvent) => {
  if (!visible.value) return
  if (ev.key === 'Escape') { close(); return }
  // basic focus trap: keep tab within panel
  if (ev.key === 'Tab') {
    const container = panel.value
    if (!container) return
    const focusable = Array.from(container.querySelectorAll<HTMLElement>('a,button,input,select,textarea,[tabindex]:not([tabindex="-1"])'))
      .filter(el => !el.hasAttribute('disabled') && el.offsetParent !== null)
    if (!focusable.length) return
    const first = focusable[0]
    const last = focusable[focusable.length - 1]
    if (!ev.shiftKey && document.activeElement === last) {
      first.focus()
      ev.preventDefault()
    } else if (ev.shiftKey && document.activeElement === first) {
      last.focus()
      ev.preventDefault()
    }
  }
}

onMounted(() => {
  window.addEventListener('keyboard-help-toggle', onGlobalToggle as EventListener)
  window.addEventListener('keydown', onKey)
  // expose a direct toggle function for reliability when other components call it
  ;(window as any).toggleKeyboardHelp = () => { if (visible.value) close(); else open() }
})
onBeforeUnmount(() => {
  window.removeEventListener('keyboard-help-toggle', onGlobalToggle as EventListener)
  window.removeEventListener('keydown', onKey)
  try { delete (window as any).toggleKeyboardHelp } catch (e) {}
})
</script>

<style scoped>
.keyboard-help-overlay {
  position: fixed;
  inset: 0;
  background: rgba(10,10,10,0.45);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 110;
}
.keyboard-help-panel {
  width: min(920px, 94%);
  max-height: 86vh;
  background: var(--brand-panel);
  color: var(--text-dark);
  border-radius: 12px;
  box-shadow: var(--shadow);
  padding: 1rem;
  outline: none;
  display: flex;
  flex-direction: column;
}
.kbd-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:0.5rem;
}
.kbd-header h3 { margin:0; }
.kbd-header .close {
  background: transparent;
  border: none;
  font-size: 1.1rem;
  cursor: pointer;
}
.kbd-body {
  overflow:auto;
  padding: 0.5rem 0;
}

.kbd-content {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.shortcut-group {
  border-bottom: 1px solid var(--border-color);
  padding-bottom: 1rem;
}

.shortcut-group:last-child {
  border-bottom: none;
  padding-bottom: 0;
}

.group-title {
  margin: 0 0 0.75rem 0;
  color: var(--text-dark);
  font-size: 1rem;
  font-weight: 600;
}
.kbd-image {
  max-width: 100%;
  border-radius: 8px;
  background: linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.02));
}
.shortcuts { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:0.6rem; }
.shortcuts li { line-height:1.5; }
.shortcuts kbd { background:#f3f3f3; padding:0.12rem 0.4rem; border-radius:4px; border:1px solid #e3e3e3; }
.kbd-footer { margin-top:0.75rem; text-align:right; color:var(--text-muted); }
.shortcuts .kbd { display:inline-flex; gap:0.25rem; align-items:center; }
.kbd-key {
  display:inline-block;
  min-width:24px;
  text-align:center;
  padding:0.18rem 0.45rem;
  border-radius:6px;
  border:1px solid rgba(0,0,0,0.08);
  background: #f7f7f7;
  color: var(--text-dark);
  font-weight:600;
  box-shadow: 0 1px 0 rgba(0,0,0,0.03), inset 0 -1px 0 rgba(255,255,255,0.6);
}
.kbd-key.highlight {
  background: var(--accent-color);
  color: var(--text-light);
  border-color: rgba(0,0,0,0.06);
  box-shadow: 0 6px 18px rgba(39,64,96,0.16);
}

/* Mac-specific styles */
.mac-note {
  background: #e3f2fd;
  padding: 0.75rem;
  border-radius: 6px;
  border-left: 4px solid #2196f3;
  margin-top: 1rem;
}

.mac-info {
  margin-top: 0.5rem;
  padding: 0.5rem;
  background: #fff3cd;
  border-radius: 4px;
  border: 1px solid #ffeaa7;
}

.mac-info small {
  color: #856404;
}
</style>


